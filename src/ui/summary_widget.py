"""
Summary Widget - Resumo da Reuni√£o
====================================

Exibe o resumo gerado pela IA ap√≥s o t√©rmino da an√°lise.
"""

from PyQt6.QtWidgets import (
    QWidget, QVBoxLayout, QLabel, QPushButton, QScrollArea, 
    QFrame, QHBoxLayout, QTextEdit
)
from PyQt6.QtCore import Qt, pyqtSignal
from PyQt6.QtGui import QFont
from typing import Dict, Any

class SummaryWidget(QWidget):
    """Widget para exibir o resumo da reuni√£o."""
    
    back_to_start_requested = pyqtSignal()
    
    def __init__(self, parent=None):
        super().__init__(parent)
        self.current_summary = None
        self._setup_ui()

    def _setup_ui(self):
        """Configurar a interface do widget."""
        main_layout = QVBoxLayout(self)
        main_layout.setContentsMargins(20, 20, 20, 20)
        main_layout.setSpacing(15)

        # Header
        header_layout = QHBoxLayout()
        title_label = QLabel("üìã Resumo da Reuni√£o")
        title_font = QFont()
        title_font.setPointSize(24)
        title_font.setWeight(QFont.Weight.Bold)
        title_label.setFont(title_font)
        title_label.setStyleSheet("color: #ECEFF4;")
        
        back_button = QPushButton("‚Üê Voltar")
        back_button.setObjectName("secondaryButton")
        back_button.clicked.connect(self.back_to_start_requested)

        header_layout.addWidget(title_label)
        header_layout.addStretch()
        header_layout.addWidget(back_button)
        
        main_layout.addLayout(header_layout)

        # √Årea de Resumo
        self.summary_text = QTextEdit()
        self.summary_text.setReadOnly(True)
        self.summary_text.setStyleSheet("""
            QTextEdit {
                background: rgba(46, 52, 64, 0.8);
                border: 1px solid rgba(129, 161, 193, 0.3);
                border-radius: 8px;
                color: #ECEFF4;
                font-family: 'Segoe UI', sans-serif;
                font-size: 14px;
                line-height: 1.6;
                padding: 15px;
            }
        """)
        main_layout.addWidget(self.summary_text)
        
        # Bot√µes de A√ß√£o
        action_layout = QHBoxLayout()
        action_layout.addStretch()

        self.export_md_button = QPushButton("üìÑ Exportar MD")
        self.export_md_button.setObjectName("actionButton")
        self.export_md_button.clicked.connect(self._export_markdown)

        self.export_pdf_button = QPushButton("üìï Exportar PDF")
        self.export_pdf_button.setObjectName("actionButton")
        self.export_pdf_button.clicked.connect(self._export_pdf)

        self.save_history_button = QPushButton("üíæ Salvar Hist√≥rico")
        self.save_history_button.setObjectName("actionButton")
        self.save_history_button.clicked.connect(self._save_to_history)

        action_layout.addWidget(self.export_md_button)
        action_layout.addWidget(self.export_pdf_button)
        action_layout.addWidget(self.save_history_button)
        
        main_layout.addLayout(action_layout)
        
        # Mostrar dados de exemplo inicialmente
        self._show_example_summary()

    def update_summary(self, summary_data: Dict[str, Any]):
        """Atualizar o resumo exibido."""
        try:
            self.current_summary = summary_data
            self._format_and_display_summary(summary_data)
            print("‚úÖ Resumo atualizado no SummaryWidget")
        except Exception as e:
            print(f"‚ùå Erro ao atualizar resumo: {e}")
            self._show_error_summary(str(e))

    def _format_and_display_summary(self, summary):
        """Formatar e exibir o resumo."""
        try:
            html_content = f"""
            <div style='font-family: "Segoe UI", sans-serif; line-height: 1.6;'>

            <h2 style='color: #88C0D0; border-bottom: 2px solid #88C0D0; padding-bottom: 10px;'>
                üéØ Pontos Principais
            </h2>
            """

            # Pontos principais
            key_points = summary.get('key_points', [])
            if key_points:
                for point in key_points:
                    html_content += f"<p style='margin: 10px 0;'>‚Ä¢ {point}</p>"
            else:
                html_content += "<p style='color: #888888;'>Nenhum ponto principal identificado</p>"

            html_content += "<br>"

            # Obje√ß√µes
            html_content += f"""
            <h2 style='color: #A3BE8C; border-bottom: 2px solid #A3BE8C; padding-bottom: 10px;'>
                üö® Obje√ß√µes Tratadas
            </h2>
            """

            objections = summary.get('objections', [])
            if objections:
                for obj in objections:
                    handled_icon = "‚úÖ" if obj.get('handled', False) else "‚ùå"
                    type_text = obj.get('type', 'N/A').upper()
                    note_text = obj.get('note', '')
                    html_content += f"<p style='margin: 10px 0;'>{handled_icon} <strong>{type_text}</strong>: {note_text}</p>"
            else:
                html_content += "<p style='color: #888888;'>Nenhuma obje√ß√£o detectada</p>"

            html_content += "<br>"

            # Pr√≥ximos passos
            html_content += f"""
            <h2 style='color: #EBCB8B; border-bottom: 2px solid #EBCB8B; padding-bottom: 10px;'>
                üìù Pr√≥ximos Passos
            </h2>
            """

            next_steps = summary.get('next_steps', [])
            if next_steps:
                for step in next_steps:
                    desc = step.get('desc', '')
                    due = f" (at√© {step.get('due', 'N/A')})" if step.get('due') else ""
                    owner = f" - {step.get('owner', '')}" if step.get('owner') else ""
                    html_content += f"<p style='margin: 10px 0;'>‚Ä¢ {desc}{due}{owner}</p>"
            else:
                html_content += "<p style='color: #888888;'>Nenhum pr√≥ximo passo definido</p>"

            html_content += "<br>"

            # M√©tricas
            html_content += f"""
            <h2 style='color: #D08770; border-bottom: 2px solid #D08770; padding-bottom: 10px;'>
                üìä M√©tricas da Chamada
            </h2>
            """

            metrics = summary.get('metrics', {})
            if metrics:
                html_content += f"""
                <p style='margin: 8px 0;'>‚è±Ô∏è <strong>Tempo de fala vendedor:</strong> {metrics.get('talk_time_vendor_pct', 0):.1f}%</p>
                <p style='margin: 8px 0;'>üé§ <strong>Tempo de fala cliente:</strong> {metrics.get('talk_time_client_pct', 0):.1f}%</p>
                <p style='margin: 8px 0;'>üòä <strong>Sentimento m√©dio:</strong> {metrics.get('sentiment_avg', 0):.2f}</p>
                <p style='margin: 8px 0;'>üö® <strong>Obje√ß√µes totais:</strong> {metrics.get('objections_total', 0)}</p>
                <p style='margin: 8px 0;'>‚úÖ <strong>Obje√ß√µes resolvidas:</strong> {metrics.get('objections_resolved', 0)}</p>
                <p style='margin: 8px 0;'>üí∞ <strong>Sinais de compra:</strong> {metrics.get('buying_signals', 0)}</p>
                """
            else:
                html_content += "<p style='color: #888888;'>M√©tricas n√£o dispon√≠veis</p>"

            # Insights
            insights = summary.get('insights', {})
            if insights:
                html_content += "<br>"
                html_content += f"""
                <h2 style='color: #B48EAD; border-bottom: 2px solid #B48EAD; padding-bottom: 10px;'>
                    üí° Insights Estrat√©gicos
                </h2>
                <p style='margin: 8px 0;'>üéØ <strong>Interesse do cliente:</strong> {insights.get('cliente_interesse', 'N/A')}</p>
                <p style='margin: 8px 0;'>‚è∞ <strong>Urg√™ncia:</strong> {insights.get('urgencia', 'N/A')}</p>
                <p style='margin: 8px 0;'>üë§ <strong>Autoridade de decis√£o:</strong> {insights.get('autoridade_decisao', 'N/A')}</p>
                <p style='margin: 8px 0;'>üé™ <strong>Pr√≥xima a√ß√£o recomendada:</strong> {insights.get('proxima_acao_recomendada', 'N/A')}</p>
                """

            html_content += "</div>"

            self.summary_text.setHtml(html_content)

        except Exception as e:
            print(f"‚ùå Erro ao formatar resumo: {e}")
            self._show_error_summary(str(e))

    def _show_example_summary(self):
        """Mostrar resumo de exemplo."""
        example_summary = {
            "key_points": [
                "Cliente demonstrou interesse na solu√ß√£o",
                "Discutiu integra√ß√£o com sistema legado",
                "Mencionou necessidade de suporte t√©cnico"
            ],
            "objections": [
                {"type": "preco", "handled": True, "note": "Explicado ROI de 340% em 18 meses"},
                {"type": "timeline", "handled": False, "note": "Cliente precisa aprovar com equipe t√©cnica"}
            ],
            "next_steps": [
                {"desc": "Enviar proposta t√©cnica detalhada", "due": "2025-01-17", "owner": "vendedor"},
                {"desc": "Agendar demonstra√ß√£o para equipe t√©cnica", "due": "2025-01-24", "owner": "vendedor"},
                {"desc": "Preparar case study similar", "due": "2025-01-18", "owner": "vendedor"}
            ],
            "metrics": {
                "talk_time_vendor_pct": 55.0,
                "talk_time_client_pct": 45.0,
                "sentiment_avg": 0.75,
                "objections_total": 2,
                "objections_resolved": 1,
                "buying_signals": 3
            },
            "insights": {
                "cliente_interesse": "alto",
                "urgencia": "media",
                "autoridade_decisao": "influenciador",
                "proxima_acao_recomendada": "demo"
            }
        }
        self._format_and_display_summary(example_summary)

    def _show_error_summary(self, error_msg: str):
        """Mostrar mensagem de erro."""
        error_html = f"""
        <div style='color: #BF616A; font-size: 16px; text-align: center; margin-top: 50px;'>
            <h2>‚ùå Erro ao carregar resumo</h2>
            <p>{error_msg}</p>
            <p style='color: #888888; font-size: 14px;'>Tente gerar o resumo novamente.</p>
        </div>
        """
        self.summary_text.setHtml(error_html)

    def _export_markdown(self):
        """Exportar resumo em formato Markdown."""
        if not self.current_summary:
            print("‚ö†Ô∏è Nenhum resumo dispon√≠vel para exportar")
            return

        try:
            # Gerar conte√∫do Markdown
            md_content = self._generate_markdown_content(self.current_summary)

            # Salvar arquivo
            from PyQt6.QtWidgets import QFileDialog
            file_name, _ = QFileDialog.getSaveFileName(
                self, "Salvar Resumo", "", "Markdown Files (*.md);;All Files (*)"
            )

            if file_name:
                with open(file_name, 'w', encoding='utf-8') as f:
                    f.write(md_content)
                print(f"‚úÖ Resumo salvo em: {file_name}")

        except Exception as e:
            print(f"‚ùå Erro ao exportar Markdown: {e}")

    def _export_pdf(self):
        """Exportar resumo em formato PDF."""
        print("üìÑ Exportar PDF - Fun√ß√£o em desenvolvimento")

    def _save_to_history(self):
        """Salvar resumo no hist√≥rico."""
        print("üíæ Salvar no hist√≥rico - Fun√ß√£o em desenvolvimento")

    def _generate_markdown_content(self, summary) -> str:
        """Gerar conte√∫do Markdown do resumo."""
        md = "# üìã Resumo da Reuni√£o\n\n"

        # Pontos principais
        md += "## üéØ Pontos Principais\n"
        for point in summary.get('key_points', []):
            md += f"- {point}\n"
        md += "\n"

        # Obje√ß√µes
        md += "## üö® Obje√ß√µes Tratadas\n"
        for obj in summary.get('objections', []):
            status = "‚úÖ" if obj.get('handled') else "‚ùå"
            md += f"- {status} **{obj.get('type', '').upper()}**: {obj.get('note', '')}\n"
        md += "\n"

        # Pr√≥ximos passos
        md += "## üìù Pr√≥ximos Passos\n"
        for step in summary.get('next_steps', []):
            due = f" (at√© {step.get('due')})" if step.get('due') else ""
            owner = f" - {step.get('owner')}" if step.get('owner') else ""
            md += f"- [ ] {step.get('desc', '')}{due}{owner}\n"
        md += "\n"

        # M√©tricas
        md += "## üìä M√©tricas da Chamada\n"
        metrics = summary.get('metrics', {})
        md += f"- ‚è±Ô∏è Tempo de fala vendedor: {metrics.get('talk_time_vendor_pct', 0):.1f}%\n"
        md += f"- üé§ Tempo de fala cliente: {metrics.get('talk_time_client_pct', 0):.1f}%\n"
        md += f"- üòä Sentimento m√©dio: {metrics.get('sentiment_avg', 0):.2f}\n"
        md += f"- üö® Obje√ß√µes totais: {metrics.get('objections_total', 0)}\n"
        md += f"- ‚úÖ Obje√ß√µes resolvidas: {metrics.get('objections_resolved', 0)}\n"
        md += f"- üí∞ Sinais de compra: {metrics.get('buying_signals', 0)}\n\n"

        # Insights
        insights = summary.get('insights', {})
        if insights:
            md += "## üí° Insights Estrat√©gicos\n"
            md += f"- üéØ Interesse do cliente: {insights.get('cliente_interesse', 'N/A')}\n"
            md += f"- ‚è∞ Urg√™ncia: {insights.get('urgencia', 'N/A')}\n"
            md += f"- üë§ Autoridade de decis√£o: {insights.get('autoridade_decisao', 'N/A')}\n"
            md += f"- üé™ Pr√≥xima a√ß√£o recomendada: {insights.get('proxima_acao_recomendada', 'N/A')}\n"

        return md
